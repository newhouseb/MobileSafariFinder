<html>
  <head>
    <title>Apache Sandbox</title>
    <style type="text/css">
    .highlight {
      background-color: yellow;
      -webkit-box-shadow: 3px 3px 3px rgba(0, 0, 0, 0.5);
      -webkit-border-radius:5px;
      padding: 2px;
    }

    .focused {
      font-weight: bold;
      padding: 5px;
      border: 1px solid black;
    }
    </style>
    <script type="text/javascript">

// The index of highlight we've focused on
var highlightIndex = 0;
var highlightCount = 0;

function searchDown() {
    highlightIndex = (highlightIndex + 1) % highlightCount;
    focusHighlight();
}

function searchUp() {
    highlightIndex = (highlightCount + highlightIndex - 1) % highlightCount;
    focusHighlight();
}

function focusHighlight() {
    var highlights = document.getElementsByClassName('highlight');
    
    var focused = document.getElementsByClassName('focused');
    for(var i = 0; i < focused.length; i++) {
      focused[i].className = "highlight";
    }

    highlights[highlightIndex].className = "highlight focused";
    document.getElementById('count').innerHTML = '' + (highlightIndex + 1) + "/" + highlightCount;
}

function search(term) {
    // Remove all previous highlight nodes
    var highlights = document.getElementsByClassName('highlight');
    for(var i = 0; i < highlights.length; i++) {
      var el = highlights[i];
      el.previousSibling.nodeValue += el.innerHTML + el.nextSibling.nodeValue;
      el.parentNode.removeChild(el.nextSibling);
      el.parentNode.removeChild(el);
      i -= 1;
    }

    if(term == '') return;

    var count = 0;
    var regex = new RegExp(term, "gi");
    var recurser = function(el){
	// If the node is text
        if ((el.nodeType == 3)||(el.nodeName =="BR")) {
	  // Search for the object
	  var position = el.nodeValue.search(regex);
	
	  // If found and this isn't a highlight
	  if(position >= 0 && el.parentNode.className != "highlight") {
	    count += 1;

	    // Create the highlight
	    var highlight = document.createElement("span");
	    highlight.className = "highlight";
	    highlight.innerHTML = el.nodeValue.substring(position, position + term.length);

	    // Create the text after the highlight
	    var postText = document.createTextNode(el.nodeValue.slice(position + term.length));

	    // Trim text before the highlight
	    el.nodeValue = el.nodeValue.slice(0, position);

	    // Add it all together
	    if(el.nextSibling) {
	      el.parentNode.insertBefore(postText, el.nextSibling);
	      el.parentNode.insertBefore(highlight, el.nextSibling);
	    } else {
	      el.parentNode.appendChild(highlight);
	      el.parentNode.appendChild(postText);
	      // Tell the caller we can skip two nodes
	      return 1;
	    }
	  }
        } else {
          for (var i=0; i < el.childNodes.length; ++i) {
            i += recurser(el.childNodes[i]);
	  }
	}
	return 0;
    };
    recurser(document);
    highlightIndex = 0;
    highlightCount = count;
    focusHighlight();
}
    </script>
  </head>
  <body>
    <input onkeyup="search(document.getElementById('term').value);" id="term" />
    <button onclick="search(document.getElementById('term').value);">search</button>
    <span id=count>0</span>
    <button onclick="searchDown();">\/</button>
    <button onclick="searchUp();">/\</button>
    Apache Sandbox
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two three one two three one two three</p>
    <p>one two four one two three one two three</p>
  </body>
</html>
